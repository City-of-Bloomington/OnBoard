{#
 * @copyright 2025 City of Bloomington, Indiana
 * @license http://www.gnu.org/licenses/agpl.txt GNU/AGPL, see LICENSE
 * @param array  definitions  Notifications defined in the system
 * @param array  emails       Email queue search results
 * @param array  search       Email queue search parameters
 *
 * Email Search Form Parameters
 * @param array  events
 * @param array  committees
 *
 * Pagination
 * @param int    total
 * @param int    itemsPerPage
 * @param int    currentPage
 #}
{% extends "html/layouts/default.twig" %}
{% import  "html/macros/pagination.twig" as pagination %}
{% import  "html/macros/forms.twig" as forms %}
{% block content %}
<section>
    <header><h1>{{ _(['notification_definition', 'notification_definitions', 10]) }}</h1></header>
    {% if actionLinks %}
    {{ include('html/partials/actionLinks.twig') }}
    {% endif %}

    <table>
    {% for d in definitions %}
    <tr><td><a href="{{ uri('notifications.definitions.info', { definition_id: d.id }) }}">
                {{ _(d.event) }}
            </a>
        </td>
        <td>{% if d.committee_id %}{{ d.committee.name }}{% endif %}</td>
    </tr>
    {% endfor %}
    </table>
</section>

<section>
    <form           class="usa-form" method="get">
        <fieldset   class="usa-fieldset">
            <legend class="usa-legend usa-legend--large">Email Queue</legend>
            {{ forms.field_select(   'event',     'event',        _('event'),     search.event        ?? '', events    , false, { onchange:'this.form.submit();' } ) }}
            {{ forms.field_select('committee_id', 'committee_id', _('committee'), search.committee_id ?? '', committees, false, { onchange:'this.form.submit();' } ) }}
            {{ forms.button('submit', _('search'), 'search') }}
            <a href="{{ uri('notifications.index') }}" class="usa-button">{{ _('reset') }}</a>
        </fieldset>
    </form>

    {% if emails %}
    <table class="usa-table usa-table--compact">
    <thead>
        <tr><th>{{ _('created'  ) }}</th>
            <th>{{ _('to'       ) }}</th>
            <th>{{ _('sent'     ) }}</th>
            <th>{{ _('event'    ) }}</th>
            <th>{{ _('committee') }}</th>
        </tr>
    </thead>
    <tbody>
        {% for e in emails %}
        <tr><td>{% if isAllowed('notifications.log', 'info') %}
                <a href="{{ uri('notifications.log.info', { email_id: e.id }) }}">{{ e.created }}</a>
                {% else %}
                {{ e.created }}
                {% endif %}
            </td>
            <td>{{ e.emailto  }}</td>
            <td>{{ e.sent     }}</td>
            <td>{{ _(e.event) }}</td>
            <td>{{ e.committee.code ?? e.committee.name }}</td>
        </tr>
        {% endfor %}
    </tbody>
    </table>
    {% endif %}

    {% if total > itemsPerPage %}
        {{ pagination.pageLinks(search, total, itemsPerPage, currentPage) }}
    {% endif %}
</section>
{% endblock %}
